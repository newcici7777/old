<!DOCTYPE HTML>
<html lang="en" >
    <head>
<meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>code sharing </title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Cici's old notebook."><meta name="keywords" content="android" /><meta name="seo" content="no seo" /><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-splitter/splitter.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/base16.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">
<meta name="google-site-verification" content="65zgvtfJFNDdKge0tDpfLKShsOrANSZ0hsdp1prfxzs" />
<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/" type="image/x-icon">

<link rel="stylesheet" href="/assets/custom_css/code1.css"><link rel="stylesheet" href="/assets/custom_css/native.css"></head>
    <body>
        <div class="book">
            
            <div class="book-summary">
    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            <li class="chapter active" data-level="1.1" data-path="" data-nav-item>
                <a href="http://localhost:4000" data-nav-link>
                    old
                </a>
            </li>
            <li class="divider"></li>
            <!-- path =  -->
            
            
	
	
	<li class="chapter" data-level="1.1" data-path="http://localhost:4000" data-nav-item><a href="#" data-nav-link> Android </a><ul>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000" data-nav-item><a href="#" data-nav-link> thread </a><ul>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/android_thread/" data-nav-link> Android thread</a>
        </li></ul></li>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/kdoc/" data-nav-link> kdoc</a>
        </li>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/adb/" data-nav-link> ADB</a>
        </li>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/intellij_coroutine/" data-nav-link> Intellij 安裝Coroutine</a>
        </li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000" data-nav-item><a href="#" data-nav-link> 舊的技術 </a><ul>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/old/app_update/" data-nav-link> app update</a>
        </li>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/old/google_sign_in/" data-nav-link> Google Sign-In</a>
        </li>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/old/app_purchase/" data-nav-link> In App Purchase Flow</a>
        </li>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/old/theme_change/" data-nav-link> Theme Change</a>
        </li>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/old/chrome_tabs/" data-nav-link> Chrome Custom Tabs</a>
        </li>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/old/momery_leak/" data-nav-link> Handle Memory Leak</a>
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000" data-nav-item><a href="#" data-nav-link> error </a><ul>
	
	
	<li class="" data-nav-item>
    	<a href="/pages/android/kapt_err/" data-nav-link> kaptGenerateStubsDebugKotlin task (current target is 17) jvm target</a>
        </li></ul></li></ul></li></ul>
    </nav>
</div>
            <div class="book-body">
                <div class="book-header" role="navigation">
                    <!-- Title -->
                    <h1>
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        
                            <a href="." >code sharing</a>
                        
                    </h1>
                </div>

                <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    
                        <h1 id="/pages/android/old/code_share">code sharing</h1>
                    

                    <p>Design Patten:</p>
<ol>
  <li>Oberseve觀察者模式</li>
  <li>CallBack模式</li>
  <li>MVP(Model-View-Presenter)</li>
</ol>

<p>MVP(Model-View-Presenter)</p>
<ol>
  <li>View : 負責繪製UI元素，簡單來說就是Activity以及Fragment。</li>
  <li>View interface : 需要View的實現接口，View 通過View interface 與 Presenter進行交互，降低耦合，方便進行單元測試。</li>
  <li>Model : 負責儲存、搜尋、操作資料數據(有時候也會實現一個Model interface用來降低耦合)。</li>
  <li>Presenter : 作為View與Model交互的橋樑，處理與用戶對應的邏輯功能。</li>
</ol>

<p>MVP優點
MVP的P把所有與用戶對應的邏輯都集中在這裡，所以可以透過MOCK一個View及Model來測試P。降低程式耦合性。
讓架構更清楚了解，其實最大的好處是方便測試和移植</p>

<p>MVP：</p>
<ul>
  <li>View不直接與Model交互，而是通過與Presenter交互來與Model間接交互 
Presenter與View的交互是通過接口來進行的，更有利於添加單元測試</li>
  <li>通常View與Presenter是一對一的，但複雜的View可能綁定多個Presenter來處理邏輯
這樣的話，Activity的工作變簡單了，只用來響應生命週期，其他工作都丟到Presenter中去完成。</li>
</ul>

<p>Code:
View Interface</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LoginView</span> <span class="kd">extends</span> <span class="nc">BaseView</span><span class="o">{</span>
  <span class="kt">void</span> <span class="nf">goToLoginPage</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">goToMainPage</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">goToDownloadMultyPage</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">goToStorePage</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">goToBuyLicense</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">goToBuyMultyPage</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>View(Activity)</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="kd">implements</span> <span class="nc">IObserver</span><span class="o">,</span> <span class="nc">LoginView</span><span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">loginPresenter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginPresenter</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">loginPresenter</span><span class="o">.</span><span class="na">checkAccessTokenExpire</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">goToLoginPage</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Intent</span> <span class="n">ssoIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">,</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">SSO_LOGIN</span><span class="o">));</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">ssoIntent</span><span class="o">);</span>
    <span class="n">finish</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">goToMainPage</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"回到主頁面"</span><span class="o">);</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="n">finish</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">goToDownloadMultyPage</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">InstallMultyActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="n">finish</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">goToStorePage</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">DeepLinkActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="n">finish</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">goToBuyLicense</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">NoLicense</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="n">finish</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">goToBuyMultyPage</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">BuyMultyActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="n">finish</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>Precenter</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginPresenter</span> <span class="kd">implements</span> <span class="nc">IObserver</span> <span class="o">{</span>   
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">LoginPresenter</span> <span class="n">mInstance</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">LoginPresenter</span> <span class="nf">getmInstance</span><span class="o">(</span><span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">mInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">LoginPresenter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">mInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginPresenter</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">mInstance</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="nf">LoginPresenter</span><span class="o">(</span><span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mWeakContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="n">loginView</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LoginView</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkAccessTokenExpire</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getTokenData</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">access_token</span> <span class="o">=</span> <span class="nc">AppData</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">ACCESS_TOKEN</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">refresh_token</span> <span class="o">=</span> <span class="nc">AppData</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">REFRESH_TOKEN</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">access_token_timestamp</span> <span class="o">=</span> <span class="nc">AppData</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">ACCESS_TIMESTAMP</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">access_token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">access_token</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">refresh_token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">refresh_token</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">access_token_timestamp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">access_token_timestamp</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">))</span> <span class="o">{</span>
        <span class="o">.......</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">refresh_token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">refresh_token</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">ssoApi</span><span class="o">.</span><span class="na">getAccessTokenWithRefreshToken</span><span class="o">(</span><span class="n">refresh_token</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//開啟登入頁面</span>
        <span class="n">loginView</span><span class="o">.</span><span class="na">goToLoginPage</span><span class="o">();</span>
      <span class="o">}</span>

    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>Observe觀察者模式</p>

<p>「訂閱」後就能自動收到更新通知 的概念，
即是 觀察者模式 (Observer Pattern)。
那些被訂閱、被追蹤、被觀察的，稱為 — 主題/目標 (Subject)
而對主題感興趣的我們，則是 — 觀察者 (Observer) 
Code</p>

<p>觀察者介面</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IObserver</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">eventNotify</span><span class="o">(</span><span class="nc">Context</span> <span class="n">activity</span><span class="o">,</span> <span class="nc">IEvent</span> <span class="n">eventType</span><span class="o">,</span> <span class="nc">String</span> <span class="n">eventMsg</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>通知者Notifier</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Notifier</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Notifier</span> <span class="n">mInstance</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Looper</span> <span class="n">mLooper</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">WeakReference</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">observerList</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Notifier</span> <span class="nf">getmInstance</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">Notifier</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">mInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notifier</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">mInstance</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="nf">Notifier</span><span class="o">(){</span>
    <span class="n">observerList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">RefWatcher</span> <span class="n">refWatcher</span> <span class="o">=</span> <span class="nc">MyApplication</span><span class="o">.</span><span class="na">getRefWatcher</span><span class="o">(</span><span class="nc">MyApplication</span><span class="o">.</span><span class="na">getAppContext</span><span class="o">());</span>
    <span class="n">refWatcher</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">addObserver</span><span class="o">(</span><span class="nc">WeakReference</span><span class="o">&lt;?&gt;</span> <span class="n">observer</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">observerList</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span><span class="o">(!</span><span class="n">observerList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">observer</span><span class="o">))</span>
        <span class="n">observerList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">removeObserver</span><span class="o">(</span><span class="nc">IObserver</span> <span class="n">observer</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">observerList</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span><span class="o">(</span><span class="n">observerList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">observer</span><span class="o">))</span>
        <span class="n">observerList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="kd">extends</span> <span class="nc">Handler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Looper</span> <span class="n">mLooper</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">MyHandler</span><span class="o">(</span><span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">looper</span><span class="o">);</span>
      <span class="n">mLooper</span> <span class="o">=</span> <span class="n">looper</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">MyHandler</span><span class="o">(){</span>
      <span class="kd">super</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyEvent</span><span class="o">(</span><span class="kd">final</span> <span class="nc">WeakReference</span><span class="o">&lt;?&gt;</span> <span class="n">activity</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">IEvent</span> <span class="n">event</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">msg</span><span class="o">){</span>
    <span class="nc">Looper</span><span class="o">.</span><span class="na">prepare</span><span class="o">();</span>
    <span class="nc">MyHandler</span> <span class="n">myHandler</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">Activity</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">myHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyHandler</span><span class="o">(</span><span class="nc">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">());</span>
    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
      <span class="n">myHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyHandler</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">if</span><span class="o">(</span><span class="n">observerList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">activity</span><span class="o">)){</span>
      <span class="nc">MyRunnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyRunnable</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span><span class="n">event</span><span class="o">,</span><span class="n">msg</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">runnable</span> <span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">myHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="nc">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyRunnable</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">WeakReference</span><span class="o">&lt;?&gt;</span> <span class="n">activityRef</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">IEvent</span> <span class="n">mEvent</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">mMsg</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">MyRunnable</span><span class="o">(</span><span class="nc">WeakReference</span><span class="o">&lt;?&gt;</span> <span class="n">activity</span><span class="o">,</span><span class="nc">IEvent</span> <span class="n">event</span><span class="o">,</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">activityRef</span> <span class="o">=</span> <span class="n">activity</span><span class="o">;</span>
      <span class="n">mEvent</span> <span class="o">=</span> <span class="n">event</span><span class="o">;</span>
      <span class="n">mMsg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">IObserver</span> <span class="n">o</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IObserver</span><span class="o">)</span> <span class="n">activityRef</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
      <span class="n">o</span><span class="o">.</span><span class="na">eventNotify</span><span class="o">((</span><span class="nc">Context</span><span class="o">)</span> <span class="n">o</span><span class="o">,</span><span class="n">mEvent</span><span class="o">,</span> <span class="n">mMsg</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>觀察者實作</p>

<p>Okhttp
Callback function
GetEndDeviceListPrecenter</p>

<p>BaseActivity</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">enum</span>  <span class="nc">ToolbarType</span> <span class="o">{</span>
  <span class="no">TOOLBAR</span><span class="o">,</span><span class="c1">//沒側邊選單的toolbar</span>
  <span class="no">DRAWER_TOOLBAR</span><span class="o">,</span><span class="c1">//有側邊選單的toolbar</span>
  <span class="no">NONE</span><span class="o">;</span><span class="c1">//沒有任何一個toolbar</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
  <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">getLayoutId</span><span class="o">();</span>
  <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">initView</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">);</span>
  <span class="kd">abstract</span> <span class="nc">Context</span> <span class="nf">getActivityContext</span><span class="o">();</span>
  <span class="kd">abstract</span> <span class="nc">ToolbarType</span> <span class="nf">getToolbarType</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>繼承BaseActivity(實作抽象方法)</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NoLicense</span> <span class="kd">extends</span> <span class="nc">BaseActivity</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TAG</span> <span class="o">=</span> <span class="s">"NoLicense"</span><span class="o">;</span>
  <span class="nd">@BindView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">renew_btn</span><span class="o">)</span>
  <span class="nc">Button</span> <span class="n">renewBtn</span><span class="o">;</span>
  <span class="nd">@BindView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">no_license_title</span><span class="o">)</span>
  <span class="nc">TextView</span> <span class="n">noLicenseTitle</span><span class="o">;</span>
  <span class="nd">@Override</span>
  <span class="kt">int</span> <span class="nf">getLayoutId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_no_license</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">initView</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ButterKnife</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">fontChanger</span><span class="o">.</span><span class="na">replaceFonts</span><span class="o">((</span><span class="nc">ViewGroup</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">content</span><span class="o">));</span>
    <span class="n">fontChangerBold</span><span class="o">.</span><span class="na">replaceFonts</span><span class="o">(</span><span class="n">renewBtn</span><span class="o">);</span>
    <span class="n">fontChangerBold</span><span class="o">.</span><span class="na">replaceFonts</span><span class="o">(</span><span class="n">noLicenseTitle</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="nc">Context</span> <span class="nf">getActivityContext</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="nc">ToolbarType</span> <span class="nf">getToolbarType</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">ToolbarType</span><span class="o">.</span><span class="na">DRAWER_TOOLBAR</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@OnClick</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">renew_btn</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onViewClicked</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">DeepLinkActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="n">finish</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>BaseActivity繼承的兒子都可以用的</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="kd">implements</span> <span class="nc">IObserver</span><span class="o">,</span> <span class="nc">LoginView</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">TAG</span> <span class="o">=</span> <span class="s">"BaseActivity"</span><span class="o">;</span>
  <span class="kd">protected</span> <span class="nc">XmppController</span> <span class="n">mXmppController</span><span class="o">;</span>
  <span class="kd">protected</span> <span class="nc">XmppConnectionPresenter</span> <span class="n">mXmppConnectionPresenter</span><span class="o">;</span>
  <span class="kd">protected</span> <span class="nc">PushNotificationPresenter</span> <span class="n">mPushNotificationPresenter</span><span class="o">;</span>
  <span class="kd">protected</span> <span class="nc">FontChangeCrawler</span> <span class="n">fontChanger</span><span class="o">;</span>
  <span class="kd">protected</span> <span class="nc">FontChangeCrawler</span> <span class="n">fontChangerBold</span><span class="o">;</span>
  <span class="kd">protected</span> <span class="nc">ImageButton</span> <span class="n">menu_home_btn</span><span class="o">,</span> <span class="n">menu_profile_btn</span><span class="o">,</span> <span class="n">menu_dev_btn</span><span class="o">,</span> <span class="n">menu_security_btn</span><span class="o">;</span>
  <span class="kd">protected</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">&gt;</span> <span class="n">mContextWeakReference</span><span class="o">;</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBackPressed</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">MainActivity</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">onBackPressed</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">getToolbarType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">ToolbarType</span><span class="o">.</span><span class="na">DRAWER_TOOLBAR</span><span class="o">)</span> <span class="o">{</span><span class="c1">//是主要四個頁面</span>
      <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
      <span class="n">finish</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">getToolbarType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">ToolbarType</span><span class="o">.</span><span class="na">TOOLBAR</span> <span class="o">||</span> <span class="n">getToolbarType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">ToolbarType</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">onBackPressed</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="n">getLayoutId</span><span class="o">());</span>
    <span class="k">this</span><span class="o">.</span><span class="na">savedInstanceState</span> <span class="o">=</span> <span class="n">savedInstanceState</span><span class="o">;</span>
    <span class="n">mContextWeakReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">);</span>
    <span class="c1">//檢查網路</span>
    <span class="kt">int</span> <span class="n">connectionType</span> <span class="o">=</span> <span class="nc">APPUtils</span><span class="o">.</span><span class="na">checkConnectionType</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">connectionType</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">HttpError</span><span class="o">(</span><span class="nc">EnumError</span><span class="o">.</span><span class="na">NO_INTERNET_CONNECTION</span><span class="o">,</span> <span class="s">"network error"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">Notifier</span><span class="o">.</span><span class="na">getmInstance</span><span class="o">().</span><span class="na">addObserver</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">mXmppController</span> <span class="o">=</span> <span class="nc">XmppController</span><span class="o">.</span><span class="na">getmInstance</span><span class="o">(</span><span class="n">mContextWeakReference</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="n">mXmppConnectionPresenter</span> <span class="o">=</span> <span class="nc">XmppConnectionPresenter</span><span class="o">.</span><span class="na">getmInstance</span><span class="o">(</span><span class="n">mContextWeakReference</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="n">fontChanger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FontChangeCrawler</span><span class="o">(</span><span class="n">getAssets</span><span class="o">(),</span> <span class="s">"fonts/GOTHIC.TTF"</span><span class="o">);</span>
    <span class="n">fontChangerBold</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FontChangeCrawler</span><span class="o">(</span><span class="n">getAssets</span><span class="o">(),</span> <span class="s">"fonts/GOTHICB.TTF"</span><span class="o">);</span>
    <span class="c1">//判斷是否有toolbar</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">getToolbarType</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nl">DRAWER_TOOLBAR:</span>
        <span class="n">getDrawerToolBarSetting</span><span class="o">();</span>
        <span class="n">getMenuList</span><span class="o">();</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="nl">TOOLBAR:</span>
        <span class="n">getNoDrawerToolbarSetting</span><span class="o">();</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="nl">NONE:</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">break</span><span class="o">;</span>

    <span class="o">}</span>
<span class="c1">//    initView(savedInstanceState);</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
    <span class="n">dismissLoadView</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">protected</span> <span class="nc">Toolbar</span> <span class="nf">getToolBarSetting</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">toolbar</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">getNoDrawerToolbarSetting</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">toolbar</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">my_toolbar</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">toolbar</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">setSupportActionBar</span><span class="o">(</span><span class="n">toolbar</span><span class="o">);</span>
      <span class="nc">ActionBar</span> <span class="n">actionBar</span> <span class="o">=</span> <span class="n">getSupportActionBar</span><span class="o">();</span>
      <span class="c1">// Enable the Up button</span>
      <span class="n">actionBar</span><span class="o">.</span><span class="na">setDisplayHomeAsUpEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="c1">//actionBar.setTitle(R.string.activate);</span>
      <span class="n">getSupportActionBar</span><span class="o">().</span><span class="na">setDisplayShowTitleEnabled</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
      <span class="n">getSupportActionBar</span><span class="o">().</span><span class="na">setHomeAsUpIndicator</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">all_btn_a_back_0</span><span class="o">);</span>
      <span class="n">toolbar</span><span class="o">.</span><span class="na">setNavigationOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">onBackPressed</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">});</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">getDrawerToolBarSetting</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">toolbar</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Toolbar</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">toolbar</span><span class="o">);</span>
    <span class="n">setSupportActionBar</span><span class="o">(</span><span class="n">toolbar</span><span class="o">);</span>
    <span class="c1">//toolbar.setTitleTextColor(Color.parseColor("#ffffff"));</span>

    <span class="nc">DrawerLayout</span> <span class="n">drawer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DrawerLayout</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">drawer_layout</span><span class="o">);</span>
    <span class="nc">ActionBarDrawerToggle</span> <span class="n">toggle</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActionBarDrawerToggle</span><span class="o">(</span>
        <span class="k">this</span><span class="o">,</span> <span class="n">drawer</span><span class="o">,</span> <span class="n">toolbar</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">navigation_drawer_open</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">navigation_drawer_close</span><span class="o">);</span>
    <span class="n">drawer</span><span class="o">.</span><span class="na">addDrawerListener</span><span class="o">(</span><span class="n">toggle</span><span class="o">);</span>
    <span class="n">toggle</span><span class="o">.</span><span class="na">syncState</span><span class="o">();</span>
    <span class="c1">// 在Toolbar做最左边加上导航按钮</span>
    <span class="n">getSupportActionBar</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="n">getSupportActionBar</span><span class="o">().</span><span class="na">setDisplayHomeAsUpEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">getSupportActionBar</span><span class="o">().</span><span class="na">setHomeAsUpIndicator</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_menu</span><span class="o">);</span>
    <span class="n">getSupportActionBar</span><span class="o">().</span><span class="na">setHomeButtonEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">drawer</span><span class="o">.</span><span class="na">setLayoutDirection</span><span class="o">(</span><span class="nc">View</span><span class="o">.</span><span class="na">LAYOUT_DIRECTION_LTR</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">getMenuList</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ListView</span> <span class="n">mListView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">menu_list</span><span class="o">);</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">menuArray</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getStringArray</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">menuArray</span><span class="o">);</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">resIdArray</span> <span class="o">=</span> <span class="o">{</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">g1_logo_a_help_0</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon_forum</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">g1_logo_a_feedback_0</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon_notification</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">g1_logo_a_faq_0</span><span class="o">};</span>
    <span class="n">mListView</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="k">new</span> <span class="nc">MenuAdapter</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">menuArray</span><span class="o">,</span> <span class="n">resIdArray</span><span class="o">));</span>
    <span class="nc">HttpApi</span> <span class="n">httpApi</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpApi</span><span class="o">(</span><span class="n">mContextWeakReference</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="n">mListView</span><span class="o">.</span><span class="na">setOnItemClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">AdapterView</span><span class="o">.</span><span class="na">OnItemClickListener</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onItemClick</span><span class="o">(</span><span class="nc">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">parent</span><span class="o">,</span> <span class="nc">View</span> <span class="n">view</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
              <span class="nc">Intent</span> <span class="nc">FAQActivityIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">FAQActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
              <span class="n">startActivity</span><span class="o">(</span><span class="nc">FAQActivityIntent</span><span class="o">);</span>
              <span class="n">finish</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
              <span class="nc">Intent</span> <span class="nc">ForumActivityIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">ForumActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
              <span class="n">startActivity</span><span class="o">(</span><span class="nc">ForumActivityIntent</span><span class="o">);</span>
              <span class="n">finish</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span><span class="c1">//send feedback</span>
              <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span><span class="s">"here....1"</span><span class="o">);</span>
              <span class="n">mSendFeedBackPresenter</span><span class="o">.</span><span class="na">getDownloadURL_XMPP_APP_LogFile</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
              <span class="c1">//取得license過期的狀態</span>
              <span class="nc">SettingRepo</span> <span class="n">settingRepo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SettingRepo</span><span class="o">();</span>
              <span class="nc">String</span> <span class="n">status</span> <span class="o">=</span> <span class="n">settingRepo</span><span class="o">.</span><span class="na">getSetting</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">IS_Expire</span><span class="o">);</span>
              <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"expired status:"</span> <span class="o">+</span> <span class="n">status</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ExpireStatus</span> <span class="n">expireStatus</span> <span class="o">=</span> <span class="nc">ExpireStatus</span><span class="o">.</span><span class="na">fromStr</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
                <span class="c1">//過期後，點擊直接導 到noLicenseActivity</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">expireStatus</span> <span class="o">==</span> <span class="nc">ExpireStatus</span><span class="o">.</span><span class="na">YES</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="nc">Intent</span> <span class="nc">NotificationIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">NotificationSettingActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                  <span class="n">startActivity</span><span class="o">(</span><span class="nc">NotificationIntent</span><span class="o">);</span>
                  <span class="n">finish</span><span class="o">();</span>
                <span class="o">}</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
              <span class="c1">// get a list of running processes and iterate through them</span>
              <span class="nc">ActivityManager</span> <span class="n">am</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ActivityManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="no">ACTIVITY_SERVICE</span><span class="o">);</span>
              <span class="c1">// get the info from the currently running task</span>
              <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActivityManager</span><span class="o">.</span><span class="na">RunningTaskInfo</span><span class="o">&gt;</span> <span class="n">taskInfo</span> <span class="o">=</span> <span class="n">am</span><span class="o">.</span><span class="na">getRunningTasks</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
              <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"CURRENT Activity ::"</span> <span class="o">+</span> <span class="n">taskInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">topActivity</span><span class="o">.</span><span class="na">getClassName</span><span class="o">());</span>
              <span class="nc">Intent</span> <span class="n">browserIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">,</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"https://www.zyxel.com/AiShieldDeploy/"</span><span class="o">));</span>
              <span class="n">startActivity</span><span class="o">(</span><span class="n">browserIntent</span><span class="o">);</span>
              <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"onItemClick: getActivityContext() is null"</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">});</span>
    <span class="c1">//下方menui設定</span>
    <span class="nc">BottomMenuSetting</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">BottomMenuSetting</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">menu_home_btn</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">menu_home_btn</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">menu_home_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">menu_home_btn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">view</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">ActivityManager</span> <span class="n">am</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ActivityManager</span><span class="o">)</span> <span class="n">getApplicationContext</span><span class="o">().</span><span class="na">getSystemService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">ACTIVITY_SERVICE</span><span class="o">);</span>
        <span class="nc">ComponentName</span> <span class="n">cn</span> <span class="o">=</span> <span class="n">am</span><span class="o">.</span><span class="na">getRunningTasks</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">topActivity</span><span class="o">;</span>
        <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"current activity = "</span> <span class="o">+</span> <span class="n">cn</span><span class="o">.</span><span class="na">getClassName</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cn</span><span class="o">.</span><span class="na">getClassName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"zyxel.security.MainActivity"</span><span class="o">))</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
          <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">});</span>
    <span class="o">}</span>
    <span class="n">menu_security_btn</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">menu_security_btn</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">menu_security_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">menu_security_btn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">view</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">TimeChartActivity</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">//如果目前的activity是timechartactivity，就不再導入timechart activity</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">TimeChartActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
          <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">});</span>
    <span class="o">}</span>
    <span class="n">menu_profile_btn</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">menu_profile_btn</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">menu_profile_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">menu_profile_btn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">view</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">ActivityManager</span> <span class="n">am</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ActivityManager</span><span class="o">)</span> <span class="n">getApplicationContext</span><span class="o">().</span><span class="na">getSystemService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">ACTIVITY_SERVICE</span><span class="o">);</span>
        <span class="nc">ComponentName</span> <span class="n">cn</span> <span class="o">=</span> <span class="n">am</span><span class="o">.</span><span class="na">getRunningTasks</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">topActivity</span><span class="o">;</span>
        <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"current activity = "</span> <span class="o">+</span> <span class="n">cn</span><span class="o">.</span><span class="na">getClassName</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cn</span><span class="o">.</span><span class="na">getClassName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"zyxel.security.AccessControlActivity"</span><span class="o">))</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">AccessControlActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
          <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">});</span>
    <span class="o">}</span>
    <span class="n">menu_dev_btn</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">menu_dev_btn</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">menu_dev_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">menu_dev_btn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">view</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">DeviceListActivity</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">//如果目前的activity是DeviceListActivity，就不再導入DeviceListActivity</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">DeviceListActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
          <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">});</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">MainActivity</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">menu_home_btn</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_dashboard_select</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">TimeChartActivity</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">menu_security_btn</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_secutity_select</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">DeviceListActivity</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">menu_dev_btn</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_devicelist_select</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">AccessControlActivity</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">menu_profile_btn</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_accesscontrol_select</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//取得license過期的狀態</span>
    <span class="nc">SettingRepo</span> <span class="n">settingRepo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SettingRepo</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">status</span> <span class="o">=</span> <span class="n">settingRepo</span><span class="o">.</span><span class="na">getSetting</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">IS_Expire</span><span class="o">);</span>
    <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"expired status:"</span> <span class="o">+</span> <span class="n">status</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ExpireStatus</span> <span class="n">expireStatus</span> <span class="o">=</span> <span class="nc">ExpireStatus</span><span class="o">.</span><span class="na">fromStr</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
      <span class="c1">//過期後，點擊直接導 到noLicenseActivity</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">expireStatus</span> <span class="o">==</span> <span class="nc">ExpireStatus</span><span class="o">.</span><span class="na">YES</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">menu_home_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">menu_home_btn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">view</span> <span class="o">-&gt;</span> <span class="o">{</span>
<span class="c1">//            if (getActivityContext() instanceof NoLicense) {</span>
<span class="c1">//</span>
<span class="c1">//            } else {</span>
<span class="c1">//              Intent intent0 = new Intent(getActivityContext(), NoLicense.class);</span>
<span class="c1">//              startActivity(intent0);</span>
<span class="c1">//              finish();</span>
<span class="c1">//            }</span>
            <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
            <span class="n">finish</span><span class="o">();</span>
          <span class="o">});</span>
        <span class="o">}</span>
        <span class="c1">//過期後，點擊直接導 到OopsActivity</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">menu_profile_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">menu_profile_btn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">view</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">OopsActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">intent0</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"from"</span><span class="o">,</span> <span class="nc">AccessControlActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
            <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
            <span class="n">finish</span><span class="o">();</span>
          <span class="o">});</span>
        <span class="o">}</span>
        <span class="c1">//過期後，點擊直接導 到OopsActivity</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">menu_dev_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">menu_dev_btn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">view</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">OopsActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">intent0</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"from"</span><span class="o">,</span> <span class="nc">DeviceListActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
            <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
            <span class="n">finish</span><span class="o">();</span>
          <span class="o">});</span>
        <span class="o">}</span>
        <span class="c1">//menu下方四個按鈕的圖片顯示被選取</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">NoLicense</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">menu_home_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">menu_home_btn</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_dashboard_select</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">TimeChartActivity</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">menu_security_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">menu_security_btn</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_secutity_select</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">OopsActivity</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">from</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">"from"</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">AccessControlActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">menu_profile_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
              <span class="n">menu_profile_btn</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_accesscontrol_select</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">DeviceListActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">menu_dev_btn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
              <span class="n">menu_dev_btn</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">homefirewall_image_android_b_devicelist_select</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//如果目前頁面是AccessControl,DeviceList,DeviceDetail就導頁到OopsActivity，因為已經過期了，不能瀏覽原本頁面</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">AccessControlActivity</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">OopsActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="n">intent0</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"from"</span><span class="o">,</span> <span class="nc">AccessControlActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
          <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
          <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">DeviceListActivity</span> <span class="o">||</span> <span class="n">getActivityContext</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">DeviceDetailActivity</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Intent</span> <span class="n">intent0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">OopsActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="n">intent0</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"from"</span><span class="o">,</span> <span class="nc">DeviceListActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
          <span class="n">startActivity</span><span class="o">(</span><span class="n">intent0</span><span class="o">);</span>
          <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="cm">/**
   * 顯示Load View
   * 因BaseView也有定義showLoadView，都是呼叫BaseActivity的showLoadView()，但Inteface預設定義method是public
   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">showLoadView</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">getRootView</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">progressWindow</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">progressWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProgressWindow</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="n">view</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">progressWindow</span><span class="o">.</span><span class="na">isShowing</span><span class="o">())</span>
      <span class="n">view</span><span class="o">.</span><span class="na">post</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">progressWindow</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
      <span class="o">});</span>
  <span class="o">}</span>
  <span class="cm">/**
   * 關閉Load View
   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dismissLoadView</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">progressWindow</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">progressWindow</span><span class="o">.</span><span class="na">isShowing</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">progressWindow</span><span class="o">.</span><span class="na">dismissWindow</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">HttpError</span><span class="o">(</span><span class="nc">EnumError</span> <span class="n">error_code</span><span class="o">,</span> <span class="nc">String</span> <span class="n">errorMsg</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Error Activity: "</span> <span class="o">+</span> <span class="n">getActivityContext</span><span class="o">());</span>
    <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONObject</span><span class="o">(</span><span class="n">errorMsg</span><span class="o">);</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"message"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JSONException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">APPUtils</span><span class="o">.</span><span class="na">printStack</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="n">errorMsg</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"error msg:"</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
    <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"error code:"</span> <span class="o">+</span> <span class="n">error_code</span><span class="o">);</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">(),</span> <span class="nc">ErrorPageActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">ERR_MSG</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">ERR_CODE</span><span class="o">,</span> <span class="n">error_code</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="n">finish</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Subscribe</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receivedXmppEvent</span><span class="o">(</span><span class="nc">NotifyXmppEvent</span> <span class="n">notifyXmppEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">LogUtil</span><span class="o">.</span><span class="na">getmInstance</span><span class="o">(</span><span class="n">getActivityContext</span><span class="o">()).</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Bass Otto Event xmpp event = "</span> <span class="o">+</span> <span class="n">notifyXmppEvent</span><span class="o">.</span><span class="na">getRequestType</span><span class="o">()</span> <span class="o">+</span> <span class="s">" --&gt; "</span> <span class="o">+</span> <span class="n">notifyXmppEvent</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">());</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">notifyXmppEvent</span><span class="o">.</span><span class="na">getRequestType</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nl">CONNECTED_TO_XMPP_SERVER:</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="nl">DISCONNECTED_FROM_XMPP_SERVER:</span>
        <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"receivedXmppEvent: disconnect"</span><span class="o">);</span>
      <span class="k">case</span> <span class="nl">TIMEOUT:</span>
        <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"xmpp timeout"</span><span class="o">);</span>
      <span class="k">case</span> <span class="nl">ERROR:</span>
        <span class="n">dismissLoadView</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">errorType</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">notifyXmppEvent</span><span class="o">.</span><span class="na">responseData</span><span class="o">;</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"XMPP ERROR Type = "</span> <span class="o">+</span> <span class="n">errorType</span><span class="o">);</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"xmpp error"</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">errorType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"wait"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">goToErrorPage</span><span class="o">(</span><span class="nc">EnumError</span><span class="o">.</span><span class="na">MULTY_OFFLINE</span><span class="o">,</span> <span class="s">"xmpp error"</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">goToErrorPage</span><span class="o">(</span><span class="nc">EnumError</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">,</span> <span class="s">"xmpp error"</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="n">goToErrorPage</span><span class="o">(</span><span class="nc">EnumError</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">,</span> <span class="s">"xmpp error"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="nl">CONNECTION_ERROR:</span>
        <span class="n">myHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">reconnectingRunnable</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="nc">Runnable</span> <span class="n">reconnectingRunnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"reconnectingRunnable !!"</span><span class="o">);</span>
      <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"is login = "</span> <span class="o">+</span> <span class="nc">AppConfigs</span><span class="o">.</span><span class="na">isLogin</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">APPUtils</span><span class="o">.</span><span class="na">checkConnectionType</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mXmppConnectionPresenter</span><span class="o">.</span><span class="na">connectWithSSO</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isConnectInternetDialogShow</span> <span class="o">==</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">isConnectInternetDialogShow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="nc">AlertDialog</span> <span class="n">alertDialog</span> <span class="o">=</span> <span class="n">alertWithCallback</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">alert_network</span><span class="o">).</span><span class="na">setNegativeButton</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">alert_confirm</span><span class="o">,</span> <span class="o">(</span><span class="n">dialog</span><span class="o">,</span> <span class="n">which</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">isConnectInternetDialogShow</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">myHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">reconnectingRunnable</span><span class="o">,</span> <span class="mi">3000</span><span class="o">);</span>
          <span class="o">}).</span><span class="na">create</span><span class="o">();</span>
          <span class="n">alertDialog</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">};</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>ShareData</p>

<p>Gradle</p>

<figure class="highlight">
  <pre><code class="language-groovy" data-lang="groovy"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">buildConfigField</span> <span class="s2">"String"</span><span class="o">,</span> <span class="s2">"MULTY_CONTENT_PROVIDER"</span><span class="o">,</span> <span class="s1">'"content://com.zyxel.multyx.provider/aishield"'</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultyContentProvider</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TAG</span> <span class="o">=</span> <span class="s">"MultyContentProvider"</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">ContentResolver</span> <span class="n">resolver</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="nc">BuildConfig</span><span class="o">.</span><span class="na">MULTY_CONTENT_PROVIDER</span><span class="o">);</span>
  <span class="kd">public</span> <span class="nf">MultyContentProvider</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="n">resolver</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">Query</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">String</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"_id"</span><span class="o">,</span> <span class="s">"mac"</span><span class="o">,</span> <span class="s">"model_name"</span><span class="o">,</span> <span class="s">"access_token"</span><span class="o">,</span> <span class="s">"refresh_token"</span><span class="o">,</span> <span class="s">"expired_timestamp"</span><span class="o">};</span><span class="c1">//sql select 欄位</span>
      <span class="nc">Cursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">fields</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">cursor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">rtnMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">cursor</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="n">id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"shared data id = "</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"shared data mac = "</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"model name = "</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"shared data access token = "</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"shared data refresh token = "</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">4</span><span class="o">));</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"shared data expired timestamp = "</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>
          <span class="n">rtnMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">MULTY_ID</span><span class="o">,</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
          <span class="n">rtnMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">FOCUS_MAC</span><span class="o">,</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
          <span class="n">rtnMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">MULTY_MODEL</span><span class="o">,</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
          <span class="n">rtnMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">ACCESS_TOKEN</span><span class="o">,</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
          <span class="n">rtnMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">REFRESH_TOKEN</span><span class="o">,</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">4</span><span class="o">));</span>
          <span class="n">rtnMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">ACCESS_TIMESTAMP</span><span class="o">,</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>
<span class="c1">//          AppData.setData(SecurityConstant.MULTY_ID,cursor.getString(0));</span>
<span class="c1">//          AppData.setData(SecurityConstant.FOCUS_MAC,cursor.getString(1));</span>
<span class="c1">//          AppData.setData(SecurityConstant.MULTY_MODEL,cursor.getString(2));</span>
<span class="c1">//</span>
<span class="c1">//          AppData.setData(SecurityConstant.MULTY_ACCESS_TOKEN,cursor.getString(3));</span>
<span class="c1">//          AppData.setData(SecurityConstant.MULTY_REFRESH_TOKEN,cursor.getString(4));</span>
<span class="c1">//          AppData.setData(SecurityConstant.MULTY_ACCESS_TIMESTAMP,cursor.getString(5));</span>
          <span class="c1">//cursor.moveToNext();</span>
        <span class="o">}</span>
        <span class="n">cursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">cursor</span><span class="o">.</span><span class="na">setNotificationUri</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">(),</span> <span class="n">uri</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">rtnMap</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">APPUtils</span><span class="o">.</span><span class="na">printStack</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">Update</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span><span class="nc">String</span> <span class="n">access_token</span><span class="o">,</span><span class="nc">String</span> <span class="n">refresh_token</span><span class="o">,</span><span class="nc">String</span> <span class="n">expired_timestamp</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">APPUtils</span><span class="o">.</span><span class="na">ISNULL</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="nc">APPUtils</span><span class="o">.</span><span class="na">ISNULL</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="nc">APPUtils</span><span class="o">.</span><span class="na">ISNULL</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="nc">APPUtils</span><span class="o">.</span><span class="na">ISNULL</span><span class="o">(</span><span class="n">id</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span><span class="s">"id/access_token/refresh_token/expired_timestamp is null.please check it out."</span><span class="o">);</span>
      <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        <span class="nc">ContentValues</span> <span class="n">newRow</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ContentValues</span><span class="o">();</span>
        <span class="n">newRow</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"access_token"</span><span class="o">,</span> <span class="n">access_token</span><span class="o">);</span>
        <span class="n">newRow</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"refresh_token"</span><span class="o">,</span> <span class="n">refresh_token</span><span class="o">);</span>
        <span class="n">newRow</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"expired_timestamp"</span><span class="o">,</span> <span class="n">expired_timestamp</span><span class="o">);</span>
        <span class="nc">StringBuffer</span> <span class="n">where</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">(</span><span class="s">"_id= ? "</span><span class="o">);</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">whereArg</span> <span class="o">=</span> <span class="o">{</span><span class="n">id</span><span class="o">};</span>
        <span class="n">resolver</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">newRow</span><span class="o">,</span> <span class="n">where</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">whereArg</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">APPUtils</span><span class="o">.</span><span class="na">printStack</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//resolver.insert(uri, newRow);</span>
    <span class="c1">//</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>Open Store Front End<br />
Activity:DeepLinkActivity.java</p>

<p>ObjectStorage<br />
Step1:取得Site Name(從ObjectStorage)，若沒有site name用預設</p>

<p>Xmpp<br />
Step2:取得xmpp連線(若已經連過，就不用連)<br />
Step3:取得network id(若已經取得過，就不用再取)<br />
Setp4:取得Store Access Token</p>

<p>Cloud<br />
Step5:將取得Store Access Token及Site name帶入，並判斷型號</p>

<p>WSQ50<br />
store_url = BuildConfig.STORE_BASE_URL +”x/licenses?redirect_uri=aishieldxx://aihost/login&amp;access_token=” + storeAccessToken + “&amp;locale=”+ Locale.getDefault().getLanguage()
+”&amp;site_name=”+site_name;</p>

<p>WSQ60<br />
store_url = BuildConfig.STORE_BASE_URL + “plus/licenses?redirect_uri=aishieldxx://aihost/login&amp;access_token=” + storeAccessToken + “&amp;locale=”+ Locale.getDefault().getLanguage()” +”&amp;site_name=”+site_name;
Step6:url encoding<br />
Step7:打開網頁</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="nc">CustomTabsIntent</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomTabsIntent</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>  
<span class="nc">CustomTabsIntent</span> <span class="n">customTabsIntent</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>  
<span class="n">customTabsIntent</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_CLEAR_TOP</span><span class="o">);</span>  
<span class="k">if</span> <span class="o">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">customTabsIntent</span><span class="o">.</span><span class="na">launchUrl</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">store_url</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>Xmpp
Step8:觸發Smart Polling</p>

<p>購買完，按下x的按鈕或WebStroe “Done”的按鈕。
到TransActivity
Step9:觸發Smart Polling
Step10:清掉cache，導到License處理中的Activity</p>

<p>License Process Activity
Step11:判斷是否有處理中的License(Processing=True), 若有的話，五秒後再問一遍，直到沒有處理中的Lincese</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="k">new</span> <span class="nc">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">httpApi</span><span class="o">.</span><span class="na">getExpirationStatus</span><span class="o">(</span><span class="nc">AppData</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">STORE_ACCESS_TOKEN</span><span class="o">)),</span> <span class="mi">5000</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>Xmpp
Step12:若沒有處理中的License(Processing==False),觸發Once Polling
Step13:判斷ExpirationStatus的api中，若expire_date是null或空的，但process是false代表，已經處理完但Portal過期，接下來問Device有沒有過期
若Device回過期，就導致NoLicese的頁面,
若Device回沒過期，就5秒後繼續問expirationStatus的api(回到Step11)</p>

<p>Step14:若expire_date有值且大於今天代表potal沒過期，詢問device有沒有過期。若expire_date是小於今天，代表potal過期，回到Step13的步驟。
若Device回過期，就5秒後繼續問expirationStatus的api(回到Step11)
若Device回沒過期，就導到MainPage</p>

<p>以下是完整的Code</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kt">void</span> <span class="nf">initView</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">httpApi</span><span class="o">.</span><span class="na">getExpirationStatus</span><span class="o">(</span><span class="nc">AppData</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">STORE_ACCESS_TOKEN</span><span class="o">));</span>
<span class="o">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">eventNotify</span><span class="o">(</span><span class="nc">Context</span> <span class="n">activity</span><span class="o">,</span> <span class="nc">IEvent</span> <span class="n">eventType</span><span class="o">,</span> <span class="nc">String</span> <span class="n">eventMsg</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(!</span><span class="nc">LicenseProcessActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">isFinishing</span><span class="o">())</span> <span class="o">{</span><span class="c1">//若activity沒有被finish才做</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">eventNotify</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="n">eventType</span><span class="o">,</span> <span class="n">eventMsg</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="o">!=</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 不相等就不做事</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">eventType</span> <span class="k">instanceof</span> <span class="nc">HttpEvent</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">HttpEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpEvent</span><span class="o">)</span> <span class="n">eventType</span><span class="o">;</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">GET_EXPIRE_STATUS:</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="nc">JSONObject</span> <span class="n">json</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONObject</span><span class="o">(</span><span class="n">eventMsg</span><span class="o">);</span>
            <span class="n">expire_date_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"expired_at"</span><span class="o">);</span>
            <span class="n">processing</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">"processing"</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JSONException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"processing:"</span> <span class="o">+</span> <span class="n">processing</span><span class="o">);</span>
          <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"expire_date_str:"</span> <span class="o">+</span> <span class="n">expire_date_str</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">processing</span><span class="o">)</span> <span class="o">{</span><span class="c1">//有正在處理中，5秒後再來問</span>
            <span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(()</span> <span class="o">-&gt;</span>   <span class="n">httpApi</span><span class="o">.</span><span class="na">getExpirationStatus</span><span class="o">(</span><span class="nc">AppData</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">STORE_ACCESS_TOKEN</span><span class="o">)),</span> <span class="mi">5000</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mXmppController</span><span class="o">.</span><span class="na">setStoreOncePolling</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="nd">@Subscribe</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receivedXmppEvent</span><span class="o">(</span><span class="nc">NotifyXmppEvent</span> <span class="n">notifyXmppEvent</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(!</span><span class="nc">LicenseProcessActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">isFinishing</span><span class="o">())</span> <span class="o">{</span><span class="c1">//若activity沒有被finish才做</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">receivedXmppEvent</span><span class="o">(</span><span class="n">notifyXmppEvent</span><span class="o">);</span>
    <span class="n">dismissLoadView</span><span class="o">();</span>
    <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Otto Event xmpp event = "</span> <span class="o">+</span> <span class="n">notifyXmppEvent</span><span class="o">.</span><span class="na">getRequestType</span><span class="o">()</span> <span class="o">+</span> <span class="s">" --&gt; "</span> <span class="o">+</span> <span class="n">notifyXmppEvent</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">());</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">notifyXmppEvent</span><span class="o">.</span><span class="na">getRequestType</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">SET_STORE_ONCE_POLLING:</span>
          <span class="c1">//null就是potal過期了</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">expire_date_str</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"null"</span><span class="o">)</span> <span class="o">||</span> <span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">expire_date_str</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">isPortalLicenseExpired</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span><span class="c1">//Portal過期了</span>
            <span class="n">mXmppController</span><span class="o">.</span><span class="na">getCyberSecurityInfo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span><span class="c1">//判斷device有沒有過期,用false是因為不要再讀cache</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Date</span> <span class="n">expire_date</span> <span class="o">=</span> <span class="nc">APPUtils</span><span class="o">.</span><span class="na">fromISO8601UTCSSS</span><span class="o">(</span><span class="n">expire_date_str</span><span class="o">);</span>
            <span class="nc">TimeZone</span> <span class="n">tz</span> <span class="o">=</span> <span class="nc">TimeZone</span><span class="o">.</span><span class="na">getTimeZone</span><span class="o">(</span><span class="s">"UTC"</span><span class="o">);</span>
            <span class="nc">Calendar</span> <span class="n">cal</span> <span class="o">=</span> <span class="nc">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">tz</span><span class="o">);</span>
            <span class="kt">long</span> <span class="n">utc_now</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="na">getTimeInMillis</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1000L</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">expire_date</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">utc_now</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">//過期了</span>
               <span class="n">isPortalLicenseExpired</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span><span class="c1">//Portal過期了</span>
               <span class="n">mXmppController</span><span class="o">.</span><span class="na">getCyberSecurityInfo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span><span class="c1">//判斷device有沒有過期,用false是因為不要再讀cache</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="c1">//沒過期</span>
              <span class="n">isPortalLicenseExpired</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span><span class="c1">//Portal沒過期</span>
              <span class="n">mXmppController</span><span class="o">.</span><span class="na">getCyberSecurityInfo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span><span class="c1">//判斷device有沒有過期,用false是因為不要再讀cache</span>
            <span class="o">}</span>
          <span class="o">}</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">GET_CYBER_SECURITY_INFO:</span>
          <span class="nc">StructCyberSecurity</span> <span class="n">structCyberSecurity</span> <span class="o">=</span> <span class="o">(</span><span class="nc">StructCyberSecurity</span><span class="o">)</span> <span class="n">notifyXmppEvent</span><span class="o">.</span><span class="na">getresponseData</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">structCyberSecurity</span><span class="o">.</span><span class="na">getStatus</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">EnumSecurityFeatureStatus</span><span class="o">.</span><span class="na">ENUM_ENABLED</span><span class="o">))</span> <span class="o">{</span><span class="c1">//device過期</span>
            <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"device過期:"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isPortalLicenseExpired</span><span class="o">)</span> <span class="o">{</span><span class="c1">//portal過期</span>
              <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"portal過期:"</span><span class="o">);</span>
              <span class="n">settingRepo</span><span class="o">.</span><span class="na">insertUpdateSetting</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">IS_Expire</span><span class="o">,</span> <span class="nc">ExpireStatus</span><span class="o">.</span><span class="na">YES</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
              <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">NoLicense</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
              <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
              <span class="n">finish</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"portal沒過過期:"</span><span class="o">);</span>
              <span class="c1">//portal沒過期</span>
              <span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">httpApi</span><span class="o">.</span><span class="na">getExpirationStatus</span><span class="o">(</span><span class="nc">AppData</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">STORE_ACCESS_TOKEN</span><span class="o">)),</span> <span class="mi">5000</span><span class="o">);</span><span class="c1">//五秒後再次重新判斷</span>
            <span class="o">}</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//device沒過期</span>
            <span class="nc">LogUtil</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"device沒過期:"</span><span class="o">);</span>
            <span class="c1">//potal過期,device沒過期,視同沒過期</span>
            <span class="c1">//potal沒過期，device沒過期，視同沒過期</span>
            <span class="n">settingRepo</span><span class="o">.</span><span class="na">insertUpdateSetting</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">IS_Expire</span><span class="o">,</span> <span class="nc">ExpireStatus</span><span class="o">.</span><span class="na">NO</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
            <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
            <span class="n">finish</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>MainActivity(判斷Licnese)</p>

<p>Xmpp
Step1:GET_CyberSecurityInfo詢問Device有沒有過期。並把Device過期的結果存在手機的資料庫中。</p>

<figure class="highlight">
  <pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">if</span> <span class="o">(!</span><span class="n">structCyberSecurity</span><span class="o">.</span><span class="na">getStatus</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">EnumSecurityFeatureStatus</span><span class="o">.</span><span class="na">ENUM_ENABLED</span><span class="o">))</span> <span class="o">{</span>
  <span class="n">settingRepo</span><span class="o">.</span><span class="na">insertUpdateSetting</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">IS_Expire</span><span class="o">,</span> <span class="nc">ExpireStatus</span><span class="o">.</span><span class="na">YES</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="n">settingRepo</span><span class="o">.</span><span class="na">insertUpdateSetting</span><span class="o">(</span><span class="nc">SecurityConstant</span><span class="o">.</span><span class="na">IS_Expire</span><span class="o">,</span> <span class="nc">ExpireStatus</span><span class="o">.</span><span class="na">NO</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>Step2:GET_NETWORK_ID(並且存入multy50/60型號(若呼叫過，則不call  zap)<br />
Step3:GET_STORE_ACCESS_TOKEN,若Store Access Token是空的，要導到error page<br />
Step4:get Credentilas<br />
Step5:GET_DEV_UUID<br />
若是取不到的話，就用舊的(ps:之前有針對這個做判斷，若取不到就error page，經討論後，取不到就是用之前舊的dev uuid，最糟的狀況就是取不到就是空)</p>

<p>Cloud
Step6:若Device過期就導到No License，沒過期才做以下步驟<br />
Step7:先判斷License有沒有在處理中(Processing == True  or False)<br />
True處理中：將頁面導回License處理中的Actvity<br />
False處理完：呼叫v1/licenses/expiration_date</p>

<p>Step8:
請參考
<a href="https://docs.google.com/document/d/1F4onqD-4eiooJ0U7xyqVK2jC51l2jgmC-XNUN8c8ku8/edit#">https://docs.google.com/document/d/1F4onqD-4eiooJ0U7xyqVK2jC51l2jgmC-XNUN8c8ku8/edit#</a></p>

<p>登入</p>
<ol>
  <li>判斷有沒有Multy，
    <ul>
      <li>若有multy判斷Multy的Token有沒有以及Focus site</li>
      <li>若沒有，Aishield就自已開瀏覽器登入</li>
    </ul>
  </li>
  <li>取得user info</li>
  <li>取得PCloud paired Device</li>
  <li>Multy存在
    <ul>
      <li>判斷Pcloud paired Device的Mac跟focus Mac是否一樣</li>
      <li>型號是否相同</li>
    </ul>
  </li>
  <li>若Step4沒有找到的話
 找出Pcolud Paired的Device,型號為WSQ50/60，並且數量只有一台，就以用xmpp連到這個device
 Paired Device數量超過2台(含)以上，就跳出error(no support model),以前是直接導到下載multy</li>
  <li>若Pcloud沒任何Paired過的device就跳出請安裝Multy的頁面。</li>
</ol>

<p>GetEndDeviceListPrecenter.java</p>

</section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


<!-- introduce mathjax support -->
<script>
    function fixes_chrome_anchors() {
        let chrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        if (window.location.hash && chrome) {
            setTimeout(function () {
                var hash = window.location.hash;
                window.location.hash = "";
                window.location.hash = hash;
            }, 300);
        }
    }

    if (document.readyState === "loading") {
        // Loading hasn't finished yet
        document.addEventListener("DOMContentLoaded", fixes_chrome_anchors);
    } else {
        // `DOMContentLoaded` has already fired
        fixes_chrome_anchors();
    }
</script>

<!------上一頁與下一頁 start---------->
                    
                    
                    
                    
    
                    

                    
                    <!------上一頁與下一頁 end---------->
                </div>
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Handle Memory Leak",
            "level": "1.2",
            "depth": 1,
            "path": "_pages/android/old/momery_leak.md",
            "ref": "_pages/android/old/momery_leak.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "expandable-chapter-small2": {
                "articlesExpand": true,
            },
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": true,

                "google": false,

                "github": true,
              
                "github_link": "https://github.com",
              

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": true,
              

                "vk": false,

                "weibo": false,

                "all": ["facebook", "google", "twitter", "weibo", "instapaper", "github", "telegram"]
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            },
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "old",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_pages/android/old/code_share.md",
        "mtime": "2025-03-24 00:00:00 +0800",
        "type": "markdown"
    },
    "gitbook": {
        "version": "",
        "time": "2025-04-10 13:56:50 +0800"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
<script src="/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.js"></script>
<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>
<script src="/assets/gitbook/gitbook-plugin-splitter/splitter.js"></script>

<!--
<script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script>
-->

<script src="/assets/gitbook/custom.js"></script>
<script src="/assets/gitbook/custom-local.js"></script>

<!-- 有extra_footer_js--><!-- 進入for--><script src="/assets/js/side_bar.js"></script></body>
</html>